---
- name: Test kubeconfig sanitization in kubernetes.core modules
  block:
    - name: Create a kubeconfig dict with sensitive data for testing
      set_fact:
        test_kubeconfig:
          apiVersion: v1
          kind: Config
          current-context: test-context
          contexts:
            - name: test-context
              context:
                cluster: test-cluster
                user: test-user
          clusters:
            - name: test-cluster
              cluster:
                server: https://test-kubernetes.example.com
                certificate-authority-data: "dGVzdC1jZXJ0aWZpY2F0ZS1hdXRob3JpdHktZGF0YQ=="
          users:
            - name: test-user
              user:
                token: "dGVzdC10b2tlbi1kYXRh"
                client-certificate-data: "dGVzdC1jbGllbnQtY2VydGlmaWNhdGUtZGF0YQ=="
                client-key-data: "dGVzdC1jbGllbnQta2V5LWRhdGE="
                username: test-user

    - name: Verify that the test kubeconfig contains sensitive (dummy) data
      assert:
        that:
          - test_kubeconfig.users[0].user.token is defined
          - test_kubeconfig.users[0].user["client-certificate-data"] is defined
          - test_kubeconfig.users[0].user["client-key-data"] is defined
          - test_kubeconfig.clusters[0].cluster["certificate-authority-data"] is defined

    - name: Test k8s_info module with kubeconfig dict (should fail but test sanitization)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ test_kubeconfig }}"
        kind: Pod
        namespace: default
      register: k8s_info_result
      # This will fail because it's not a real cluster, but we want to test logging
      ignore_errors: true

    - name: Verify module execution completed (even with failure)
      assert:
        that:
          - k8s_info_result is defined
          - k8s_info_result.failed is true
        msg: "Module should have failed with fake kubeconfig but completed execution"

  always:
    - name: Clean up test variables
      set_fact:
        test_kubeconfig: null
        k8s_info_result: null
