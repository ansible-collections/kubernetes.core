---
- name: Test kubeconfig sanitization in kubernetes.core modules
  block:
    - name: Create a kubeconfig dict with sensitive data for testing
      set_fact:
        test_kubeconfig:
          apiVersion: v1
          kind: Config
          current-context: test-context
          contexts:
            - name: test-context
              context:
                cluster: test-cluster
                user: test-user
          clusters:
            - name: test-cluster
              cluster:
                server: https://test-kubernetes.example.com
                certificate-authority-data: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMrVENDQWVHZ0F3SUJBZ0lKQUpHZ2xCcENLa1E2TUEwR0NTcUdTSWIzRFFFQkJRVUFNQlF4RWpBUUJnTlYKQkFNTUNTQnRlWE4wWlhKMGN5NHdIaGNOTVRrd05ESTFNVEk1TWpNeVdoY05Nall3TkRJMU1USTVNak15V2pBUwpNUkF3RGdZRFZRUUREQWR0ZVhOMFpYSjBjekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DCmdnRUJBTi9sQy8yWEtOVkVYaHdyNi9JeGI5WG4rVER2c3Q2a0QyaGNaWThZbmRGNmdJa3k1RXQwbkF6SGFER3YKa1BLZU0yQ3dVZTJTdnhMY3V6byt6TlhIeS9nWGIxMDBrV2M4SXAybkdSQ0c3bkwycFY5T0lvQUpoZE5vN0dFUgpIdlI3SjdHTk5Md2V3Zlh2U1RyRzBVYzBLWGJKaGRzZklteGFSTFV5Njlyc0VvcldlRGNQVmp3UzJkN1dSWlVCCmVYSE9DdDJHR2J0VTE1cmhXRlpZWjJPWStPMHh6NGt5SmVSZFRIaVVFeTJ4MTBkSmZNSkt6bXZMdTNYVGdpWjEKd01mSEtaTDY4eHNKd3dFTkgwbFRNbllyeEc1d2hKbjNjTzQ1QlpEZTdGeE1oS2NiK3dOc2JxV1M5Tk9vWXF2VQplM0x0a2ZwQmV3TGNwdDZibzU5ZC9PQ1NBUU1DQXdFQUFhT0RNUUF3RGdZRFZSME9CQWNFQkM5VElSQkFNQTBHCkNTcUdTSWIzRFFFQkJRVUFBNElCQVFBRUpZR1Qzdk5jNGIzR2hvV0hrNVNEaTFqN2cyckFPSUE0OXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t"
          users:
            - name: test-user
              user:
                token: "eyJhbGciOiJSUzI1NiIsImtpZCI6InNlbnNpdGl2ZS10b2tlbi1kYXRhIn0.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InRlc3QtdG9rZW4tNXJxdDIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoidGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjEyMzQ1Njc4LTEyMzQtMTIzNC0xMjM0LTEyMzQ1Njc4OTBhYiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnRlc3QifQ.SENSITIVE_JWT_SIGNATURE_DATA"
                client-certificate-data: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMrVENDQWVHZ0F3SUJBZ0lKQUpHZ2xCcENLa1E2TUEwR0NTcUdTSWIzRFFFQkJRVUFNQlF4RWpBUUJnTlYKQkFNTUNTQnRlWE4wWlhKMGN6TUJNREEwTmpVeE1qVXdOak13TmpBd1dqQVNNUkF3RGdZRFZRUUREQWR0ZVhOMFpYSjBjekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFOL2xDLzJYS05WRVhod3I2L0l4YjlYbitURHZzdDZrRDJoY1pZOFluZEY2Z0lreTVFdDBuQXpIQURHdmtQS2VNMkN3VWUyU3Z4TGN1em8rekRYSHkvZ1hiMTAwa1djOElwMm5HUkNHN25MMnBWOU9Jb0FKaGRObzdHRVJIdlI3SjdHTk5Md2V3Zlh2U1RyRzBVYzBLWGJKaGRzZklteGFSTFV5Njlyc0VvcldlRGNQVmp3UzJkN1dSWlVCZVhIT0N0MkdHYnRVMTVyaFdGWllaM085Kzh4ejRreUplUmRUSGlVRXkyeDEwZEpmTUpLem12THUzWFRnaVoxd01mSEtaTDY4eHNKd3dFTkgwbFRNbllyeEc1d2hKbjNjTzQ1QlpEZTdGeE1oS2NiK3dOc2JxV1M5Tk9vWXF2VWUzTHRrZnBCZXdMY3B0NmJvNTlkL09DTEFQY01DQXdFQUFhT0RNUUEwRGdZRFZSME9CQWPFQUM5VElSQkFNQTBHQ1NxR1NJYjNEUUVCQlFVQUE0SUJBUUFlamVHUGo5VmYyU2ZKNElxdTFhY0ZvQVhUdmFpcjNlOWY0aUxNb2JxM1E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t"
                client-key-data: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRGY1UXY5bHlqVlJGNGNLCit2eU1XL1Y1L2t3NzdMZXBBOW9YR1dQR0ozUmVvQ0pNdVJMZEp3TXh3QXhyNUR5bmpOZ3NGSHRrcjhTM0xzNlAKc3pWeDBiNEYyOWROSkZuUENLZHB4a1FodTVpOXFWZlRpS0FDWVhUYU94aEVSNzBleWV4alRTOEhzSDE3MGs2eAp0RkhOQ2wyeVlYYkh5SnNXa1MxTXV2YTdCS0sxbmczRDFZOEV0bmUxa1dWQVhseHpncmRoaG03Vk5lYTRWaFdXCkdkanFQam5NaytKTWlYa1hVeDRsQk10c2RkSFNYekNTczVyeTd0MTA0SW1kY0RIeHltUyt2TWJDY01CRFIsSlUKeko2SzhSdWNJU1o5M0R1T1FXUTN1eGNUSVNuRy9zRGJHNmxrdlRUcUdLcjFIdHk3Wkg2UVhzQzNLYmVtNk9mWApmemcyL0xnbWFKVWxBZ01CQUFFQ2dnRUJBTFl4SkZsSDlsZDNUUnAwSlQvblFxMzR5TEZxYytjeVR2WkY4dVpvCkd6N28vRWJWb0V0U3BZQjNOQXkyaTcyQ2J3ZlQ4U2VlWmpnLzJQQjg5SFZvNTFwOW5Ea3JSdk1yN2ZqN3Q5KzUKOGxtSTlDNThxbkNIUkVqSmlLbEhlSElGZHR2TnhRMS9CV1dmNWh5MUkzOWYvQzZnWTNteGgzdWNxOXQ4VjVHWApOQXlqL2t5VTJrSkV3Q0lSWVVnVEJmSXNLODZ0TDlpTmFPN1p5UXp5czY0SzRwMDZGem81UXVnVEJGc1kvZklhCm4rbjJYcFRXMDBqUU1UUXlTRlFWRE1seVRrOGJmd0ljZE5LblJSMUZmdVhha2RYQVdKaTA3bXVLRy9JNGJaYysKcGJTVmU1dGRFc3k0R1RMamZ5eDNMTEpTa3Z1VmdnQnFYbzVKemh3b0xzOENnWUVBOWJQUkZvUGFSNzdtcHV5dwpMWUppZjZKT3YrZEdWcVl3bHhncENUNFpCNjIveU1pSDV0SWlNYnZab3NIZnZScmlUcmlpSzJ5eVl1a3g4VlFVCnRnYWFHN2s1cGp2Q2FKSi9kNzlCNkJEQy8wOEJjNy9jNXhBVDJpSmRNUks5TFlPODNWcElYd1pNTU5qdUtsek8KTndNcVQrNXVNdVMrZzhPdmZLbE5lMDRSL3p6WkhpcXZjZ1lFQVdvYkZqdElBbzVVVWszUDBhbXFDUTh3bC9EeAp1MGliN3pkeEZ5WWY3d3BENXNxd3lJL1YxWlZmMmFOOHhMWUpHWGRqVXI2VE1qT3o5a2N6MkgzZmNqcXNrRjNWCmxJMVkrSjBoa1k5UldGSlNqWm9ObVltR2tSd1ptU0VkYzVrRnh3VnJUOXJiaENFc3ZIdkU5OGVvUHFNNWdUQzcKazR3U05KWUNWbnA1R0FMaTBPRGxEcWFsMHNzQ2dZRUE5TEF2UzRORmY3a0dnZVZpeGVvRWhGYjJ0UlBWQnVSeAp6SGx2QVpNMTV4OXdLQmdrWGpLOGRqZGMxWGxhYUkzR2c2STZsNEl2Z0wyQmZNTnpSMTdXV0twNnZJVUx1WXJGCkdMNUs5REJMR01TMWNnRWJxWXF5WWN4T3QzNFBKNjhWbVlKSjJSQXhSVXBINzNnL2J1aEU1eWNLNDBQUGZSdksKdHkrQVVRa0JhcC9zQ2dZRUF5UnF2bEhqaVJRa3hOMzVMbUJSRU1FK2tZZWQyVDNXTklZeHB6K0psSWRnVXBLLwpNV0UwZlJzMEZSWnVEK2JzZUV3MWVsS3R5VnFRTVk4RzVjODYwZjVhM0xNZjFjWWxiWHp6ZzZLdElnVjNGdk9vCi9EYzZhQkNZUWhIdnpoMGk4N1hxSVhFTkRaUlR1NktrSGlJQWFzZ2VPUWx1T3JCdTNaT0Zsb3p3V0VaRk1HTUMKcGJ3eHl3dWE2TXF1MEhzN3ExOHhLazgzUGhDOVJXSWRSNUJYTElCdFF5dkN4dE9XUXA2UmpQUVJEaWFad21ITQpiQ2JLdGdadXVKYXB0eG1ReHEwcndKdjdQOEZST3pYTkhGNm14U2hEWWVLcGNKYkdqbGRxQVZxWFhKV2hrU2VNClhaTUlhb2xHSWIvdmJMMmJaYy9vU3M3eCswRGJBME9vdVN0NVl0a0pEQ01YcGJuU0gzNEdhRnI5M1VBWkE9PQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t"
                username: test-user

    - name: Test k8s_info module with kubeconfig dict (should fail but test sanitization)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ test_kubeconfig }}"
        kind: Pod
        namespace: default
      register: k8s_info_result
      ignore_errors: true
      # This will fail because it's not a real cluster, but we want to test logging

    - name: Verify that the test kubeconfig contains sensitive data
      assert:
        that:
          - test_kubeconfig.users[0].user.token is defined
          - test_kubeconfig.users[0].user["client-certificate-data"] is defined
          - test_kubeconfig.users[0].user["client-key-data"] is defined
          - test_kubeconfig.clusters[0].cluster["certificate-authority-data"] is defined
        msg: "Test kubeconfig should contain sensitive data for testing"

    - name: Test sanitization function directly using Python script
      script: test_sanitization.py
      register: sanitization_test_result
      environment:
        PYTHONPATH: "{{ ansible_env.PYTHONPATH | default('') }}:{{ playbook_dir }}/../../.."
        TEST_KUBECONFIG: "{{ test_kubeconfig | to_json }}"

    - name: Display sanitization test results
      debug:
        var: sanitization_test_result.stdout_lines

  rescue:
    - name: Handle expected failures in integration test
      debug:
        msg: "Integration test completed - some failures expected due to test environment"
