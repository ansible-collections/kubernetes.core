---
- name: Test helm reuse_values
  vars:
    helm_namespace: "{{ test_namespace[14] }}"
    chart_release_values:
      replica:
        replicaCount: 3
      master:
        count: 1
        kind: Deployment
    chart_reuse_values:
      replica:
        replicaCount: 1
      master:
        count: 3
  block:
    - name: Initial chart installation
      helm:
        binary_path: "{{ helm_binary }}"
        chart_ref: oci://registry-1.docker.io/bitnamicharts/redis
        release_name: test-redis
        release_namespace: "{{ helm_namespace }}"
        create_namespace: true
        release_values: "{{ chart_release_values }}"
      register: install
      ignore_errors: true
      when: helm_version == "v4.0.0"

    - name: Debug install result
      debug:
        var: install
      when: helm_version == "v4.0.0"

    - name: Ensure helm installation was failed for v4.0.0
      assert:
        that:
          - install is failed
          - "'Helm version must be >=3.0.0,<4.0.0' in install.msg"
      when: helm_version == "v4.0.0"

  always:
    - name: Remove helm namespace
      k8s:
        api_version: v1
        kind: Namespace
        name: "{{ helm_namespace }}"
        state: absent
